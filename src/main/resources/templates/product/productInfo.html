<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoonShop - 상품 상세</title>
    
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 기존 CSS 먼저 로드 -->
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/font-awesome.min.css}" rel="stylesheet">
    <link th:href="@{/css/elegant-icons.css}" rel="stylesheet">
    <link th:href="@{/css/jquery-ui.min.css}" rel="stylesheet">
    <link th:href="@{/css/magnific-popup.css}" rel="stylesheet">
    <link th:href="@{/css/owl.carousel.min.css}" rel="stylesheet">
    <link th:href="@{/css/slicknav.min.css}" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    
    <!-- Custom CSS (마지막에 로드) -->
    <link th:href="@{/css/product/productInfo.css}" rel="stylesheet">
</head>

<body>
    <!-- Header Section -->
    <th:block th:replace="common/header :: headFragment"></th:block>
    
    <!-- 상품 페이지 시작 - CSS 범위 제한 -->
    <div class="product-page">
    
    <!-- Breadcrumb -->
    <nav class="breadcrumb-container">
        <ul class="breadcrumb">
            <li><a href="/"><i class="fas fa-home"></i></a></li>
            <li><a href="#" th:text="${product.productType.getParentCategory().get().name}"></a></li>
            <li><a href="#" th:text="${product.productType.name}"></a></li>
            <li class="active" th:text="${product.productName}"></li>
        </ul>
    </nav>
    
    <!-- Product Details Section -->
    <main class="product-container">
        <div class="product-wrapper">
            <!-- Product Images -->
            <div class="product-images">
                <div class="main-image-container">
                    <img id="mainImage" 
                         th:src="'/fileDownload?fileSeq=' + ${product.productFileList[0].file.fileSeq}" 
                         alt="Product Image">
                    <button class="zoom-btn" id="zoomBtn">
                        <i class="fas fa-search-plus"></i>
                    </button>
                </div>
                
                <div class="thumbnail-container">
                    <div class="thumbnail-item active" th:each="file, stat : ${product.productFileList}" 
                         th:onclick="'changeMainImage(' + ${file.file.fileSeq} + ', this)'">
                        <img th:src="'/fileDownload?fileSeq=' + ${file.file.fileSeq}" alt="Thumbnail">
                    </div>
                </div>
            </div>
            
            <!-- Product Info -->
            <div class="product-info">
                <div class="product-header">
                    <span class="product-brand" th:text="${product.productType.name}"></span>
                    <h1 class="product-title" th:text="${product.productName}"></h1>
                    
                    <!-- Rating -->
                    <div class="product-rating" th:if="${reviewInfo ne null}">
                        <div class="rating-stars">
                            <i class="fas fa-star" th:classappend="${reviewInfo.scoreAvg >= 1 ? 'active' : ''}"></i>
                            <i class="fas fa-star" th:classappend="${reviewInfo.scoreAvg >= 2 ? 'active' : ''}"></i>
                            <i class="fas fa-star" th:classappend="${reviewInfo.scoreAvg >= 3 ? 'active' : ''}"></i>
                            <i class="fas fa-star" th:classappend="${reviewInfo.scoreAvg >= 4 ? 'active' : ''}"></i>
                            <i class="fas fa-star" th:classappend="${reviewInfo.scoreAvg >= 5 ? 'active' : ''}"></i>
                        </div>
                        <span class="rating-text">
                            <span th:text="${#numbers.formatDecimal(reviewInfo.scoreAvg, 1, 1)}"></span>
                            (<span th:text="${reviewInfo.reviewCount}"></span>개 리뷰)
                        </span>
                    </div>
                </div>
                
                <!-- Price -->
                <div class="product-price">
                    <span class="price-label">판매가</span>
                    <span class="price-value" th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + '원'"></span>
                </div>
                
                <!-- Benefits -->
                <div class="product-benefits">
                    <div class="benefit-item">
                        <i class="fas fa-truck"></i>
                        <span>무료배송</span>
                    </div>
                    <div class="benefit-item">
                        <i class="fas fa-coins"></i>
                        <span>적립금 1%</span>
                    </div>
                    <div class="benefit-item">
                        <i class="fas fa-shield-alt"></i>
                        <span>정품보증</span>
                    </div>
                </div>
                
                <!-- Options -->
                <div class="product-options">
                    <!-- Size Selection -->
                    <div class="option-group">
                        <label class="option-label">사이즈</label>
                        <div class="size-options">
                            <th:block th:each="stock, stat : ${product.productStockList}">
                                <input type="radio" name="size" 
                                       th:id="'size-' + ${stock.productStockSeq}" 
                                       th:value="${stock.productStockSeq}"
                                       th:checked="${stat.first}"
                                       style="display: none;">
                                <label th:for="'size-' + ${stock.productStockSeq}" 
                                       class="size-btn"
                                       th:classappend="${stat.first ? 'active' : ''}"
                                       onclick="selectSize(this)">
                                    [[${stock.productSize}]]
                                </label>
                            </th:block>
                        </div>
                    </div>
                    
                    <!-- Quantity -->
                    <div class="option-group">
                        <label class="option-label">수량</label>
                        <div class="quantity-selector">
                            <button class="qty-btn minus" onclick="decreaseQuantity()">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" id="quantity" value="1" min="1" max="99">
                            <button class="qty-btn plus" onclick="increaseQuantity()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Total Price -->
                <div class="total-price">
                    <span class="total-label">총 상품금액</span>
                    <span class="total-value" id="totalPrice" 
                          data-price="${product.price}"
                          th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + '원'"></span>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="purchaseNow()">
                        바로구매
                    </button>
                    <button class="btn btn-secondary" onclick="addCart()">
                        <i class="fas fa-shopping-cart"></i>
                        장바구니
                    </button>
                    <button class="btn btn-icon" th:id="${product.productSeq}" 
                            th:classappend="${product.heart != null ? 'active' : ''}"
                            onclick="toggleHeart(this)">
                        <i class="fas fa-heart"></i>
                    </button>
                </div>
                
                <!-- Product Meta -->
                <div class="product-meta">
                    <div class="meta-item">
                        <span class="meta-label">상품코드</span>
                        <span class="meta-value" th:text="${product.productSeq}"></span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">배송정보</span>
                        <span class="meta-value">평균 2-3일 소요 (주말/공휴일 제외)</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">교환/반품</span>
                        <span class="meta-value">수령 후 7일 이내 가능</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Product Tabs -->
        <div class="product-tabs">
            <div class="tab-header">
                <button class="tab-btn active" data-tab="description">상품상세</button>
                <button class="tab-btn" data-tab="reviews">
                    리뷰 
                    <span class="badge" th:if="${reviewInfo ne null}" th:text="${reviewInfo.reviewCount}"></span>
                </button>
                <button class="tab-btn" data-tab="info">구매정보</button>
                <button class="tab-btn" data-tab="qa">Q&A</button>
            </div>
            
            <div class="tab-content">
                <!-- Description Tab -->
                <div class="tab-pane active" id="description">
                    <div class="product-description" th:if="${product.productContent ne null}">
                        <div th:utext="${product.productContent}"></div>
                    </div>
                    <div class="no-content" th:if="${product.productContent eq null}">
                        <i class="fas fa-info-circle"></i>
                        <p>상품 설명이 준비중입니다.</p>
                    </div>
                </div>
                
                <!-- Reviews Tab -->
                <div class="tab-pane" id="reviews">
                    <th:block th:replace="product/productReview :: reviewFragment"></th:block>
                </div>
                
                <!-- Info Tab -->
                <div class="tab-pane" id="info">
                    <div class="info-content">
                        <h3>배송 안내</h3>
                        <ul>
                            <li>배송비: 3,000원 (50,000원 이상 구매 시 무료배송)</li>
                            <li>배송기간: 결제완료 후 2-3일 이내 (주말/공휴일 제외)</li>
                            <li>배송지역: 전국 (일부 도서산간 지역 추가비용 발생)</li>
                        </ul>
                        
                        <h3>교환/반품 안내</h3>
                        <ul>
                            <li>교환/반품 기간: 상품 수령 후 7일 이내</li>
                            <li>교환/반품 비용: 왕복 6,000원 (단순변심)</li>
                            <li>교환/반품 불가: 상품 훼손, 택 제거, 착용 흔적이 있는 경우</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Q&A Tab -->
                <div class="tab-pane" id="qa">
                    <div class="qa-content">
                        <button class="btn btn-primary btn-sm">문의하기</button>
                        <div class="no-content">
                            <i class="fas fa-comments"></i>
                            <p>등록된 문의가 없습니다.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Image Zoom Modal -->
    <div class="modal" id="imageModal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <img class="modal-image" id="modalImage">
        </div>
    </div>
    </div>
    <!-- 상품 페이지 끝 -->
    
    <!-- Footer Section -->
    <th:block th:replace="common/footer :: footFragment"></th:block>
    
    <!-- Scripts -->
    <script type="text/javascript" th:src="@{/js/jquery-3.3.1.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/bootstrap.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/jquery.magnific-popup.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/jquery-ui.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/mixitup.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/jquery.countdown.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/jquery.slicknav.js}"></script>
    <script type="text/javascript" th:src="@{/js/owl.carousel.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/jquery.nicescroll.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/main.js}"></script>
    <script type="text/javascript" th:src="@{/js/product/productInfo.js}"></script>
    <script type="text/javascript" th:src="@{/js/common/common.js}"></script>
    
    <script>
        // Tab functionality
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.dataset.tab;
                
                // Remove active class from all tabs and panes
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding pane
                button.classList.add('active');
                document.getElementById(tabName).classList.add('active');
            });
        });
        
        // Size selection
        document.querySelectorAll('.size-btn').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
            });
        });
        
        // Image zoom
        const modal = document.getElementById('imageModal');
        const zoomBtn = document.getElementById('zoomBtn');
        const modalImage = document.getElementById('modalImage');
        const mainImage = document.getElementById('mainImage');
        const closeBtn = document.querySelector('.modal-close');
        
        zoomBtn.onclick = function() {
            modal.style.display = "block";
            modalImage.src = mainImage.src;
        }
        
        closeBtn.onclick = function() {
            modal.style.display = "none";
        }
        
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
        
        // Change main image
        function changeMainImage(fileSeq, element) {
            document.getElementById('mainImage').src = '/fileDownload?fileSeq=' + fileSeq;
            document.querySelectorAll('.thumbnail-item').forEach(item => item.classList.remove('active'));
            element.classList.add('active');
        }
        
        // Quantity functions
        function increaseQuantity() {
            const input = document.getElementById('quantity');
            const value = parseInt(input.value);
            if (value < 99) {
                input.value = value + 1;
                updateTotalPrice();
            }
        }
        
        function decreaseQuantity() {
            const input = document.getElementById('quantity');
            const value = parseInt(input.value);
            if (value > 1) {
                input.value = value - 1;
                updateTotalPrice();
            }
        }
        
        // Update total price
        function updateTotalPrice() {
            const quantity = parseInt(document.getElementById('quantity').value);
            const price = parseInt(document.getElementById('totalPrice').dataset.price);
            const total = price * quantity;
            document.getElementById('totalPrice').textContent = total.toLocaleString() + '원';
        }
        
        // Quantity input change
        document.getElementById('quantity').addEventListener('change', function() {
            if (this.value < 1) this.value = 1;
            if (this.value > 99) this.value = 99;
            updateTotalPrice();
        });
    </script>
</body>
</html>